# Changelog 1.1.2

## Additional Follower Bug Fixes (Patch Release)

This patch addresses additional follower-related errors discovered in v1.1.1.

---

## Bug Fixes

### FollowerBrainInfo Protection NullReferenceException
- **Fixed**: Additional NullReferenceException when accessing `FollowerBrainInfo.Protection` for followers not in scene
- **Fixed**: `GiveAllClothing` now only updates followers that are active in the scene
- **Fixed**: `SpawnFollower` now checks if follower is active before calling `CheckChangeState()`
- **Root Cause**: Setting outfit data on followers not loaded caused brain state checks to fail

### Improved Scene Awareness
- **GiveAllClothing**: Now checks `follower.gameObject.activeInHierarchy` before updating outfits
- **SpawnFollower**: Only calls `CheckChangeState()` when brain is fully initialized
- **Better Detection**: Uses `gameObject.activeInHierarchy` to verify follower is loaded

---

## Technical Details

### Problem
Even with v1.1.1 fixes, some operations were still causing errors:
```
NullReferenceException: Object reference not set to an instance of an object
FollowerBrainInfo.get_Protection ()
FollowerBrain.CanFreezeExcludingScarf ()
FollowerBrain.CheckChangeState ()
```

This happened when:
1. `GiveAllClothing` tried to update outfits for followers not in the active scene
2. `SpawnFollower` called `CheckChangeState()` before the brain was fully initialized
3. The game tried to check follower protection status with incomplete data

### Solution
1. **Active Scene Check**: Only update followers where `gameObject.activeInHierarchy` is true
2. **Deferred Updates**: For followers not in scene, only set data - they'll apply it when they load
3. **Safer State Changes**: Wrap `CheckChangeState()` calls in try-catch with initialization checks
4. **Better Validation**: Check both follower instance AND active state before operations

---

## Changes Made

### CultDefinitions.cs
- **GiveAllClothing()**: Added `gameObject.activeInHierarchy` check
- Only calls `SetOutfit()` for followers actually loaded in scene
- For unloaded followers, just sets clothing data

### CultUtils.cs
- **SpawnFollower()**: Added `gameObject.activeInHierarchy` check before setting outfit
- Wrapped `CheckChangeState()` in try-catch with null checks
- Only calls state change when brain is fully initialized

---

## Benefits

- **No More Protection Errors** - Scene-aware updates prevent accessing unloaded follower data
- **Safer State Changes** - Brain state only changed when fully initialized
- **Deferred Updates Work** - Followers not in scene get updates when they load
- **Robust Error Handling** - Multiple layers of validation prevent crashes

---

## Upgrade Instructions

### From v1.1.1 to v1.1.2
Simply replace the `CheatMenu.dll` file in `BepInEx/plugins/CheatMenu/` with the new version.

### From v1.1.0 to v1.1.2
Replace the DLL file. This version includes all fixes from v1.1.1 plus additional scene-awareness improvements.

### Compatibility
- ? Fully compatible with v1.1.0 and v1.1.1 save files
- ? No config file changes needed
- ? Drop-in replacement

---

## Files Changed
- `src/definitions/CultDefinitions.cs` - GiveAllClothing() improved with scene checks
- `src/CultUtils.cs` - SpawnFollower() improved with initialization checks
- `manifest.json` - Version bumped to 1.1.2

---

## Testing
- ? Build successful
- ? GiveAllClothing only updates active followers
- ? SpawnFollower safely handles worker state changes
- ? No NullReferenceException in logs
- ? Followers not in scene get updates when they load

---

**Recommended for all users of v1.1.0 and v1.1.1 to eliminate remaining follower-related errors.**
