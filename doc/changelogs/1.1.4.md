# Changelog 1.1.4

## Enhanced Protection Against Follower Loading Crashes

This release adds a **defensive patch** to the game's follower initialization code, providing protection against skeleton-related crashes from ANY source, not just cheat menu operations.

---

## What's New

### ??? Defensive Follower Initialization Patch
- **Added**: Harmony prefix patch on `Follower.Init()` that validates skeleton data before outfit application
- **Protection**: Automatically resets follower outfits to safe defaults if skeleton isn't fully initialized
- **Scope**: Protects against crashes from **any mod or game bug**, not just CheatMenu operations
- **Benefit**: Game will no longer freeze/crash when followers spawn with incomplete skeleton data

### ?? Assembly-Verified Fix
After examining the decompiled `Assembly-CSharp.dll`, we discovered:
- The game's `FollowerBrain.SetFollowerCostume()` calls `skin.AddSkin()` **without null checks**
- When `skeleton.Data.FindSkin()` returns null, it causes `NullReferenceException` in `Spine.Skin.AddSkin()`
- This can happen when follower data is modified before the skeleton is fully loaded
- **Our fix**: Intercepts `Follower.Init()` and validates skeleton state before allowing outfit changes

---

## Technical Details

### The Root Cause (Confirmed via Assembly Dump)

Looking at the game's actual code in `FollowerBrain.SetFollowerCostume()`:

```csharp
// From decompiled Assembly-CSharp.dll
public static Skin SetFollowerCostume(Skeleton skeleton, ...)
{
    Skin skin = new Skin("New Skin");
    Skin skin2 = skeleton.Data.FindSkin(skinName);
    
    // Game checks this one...
    if (skin2 != null)
    {
        skin.AddSkin(skin2);
    }
    
    // But doesn't check these!!!
    skin.AddSkin(skeleton.Data.FindSkin("Necklaces/Necklace_Bell"));
    skin.AddSkin(skeleton.Data.FindSkin("Clothes/Robes_Old"));
    skin.AddSkin(skeleton.Data.FindSkin(GetOutfitName(outfit)));
    skin.AddSkin(skeleton.Data.FindSkin("Clothes/Baby"));
    // ... 20+ more calls without null checks!
}
```

**Problem**: If `skeleton.Data` is null or incomplete, `FindSkin()` returns null, and `skin.AddSkin(null)` throws `NullReferenceException`.

### Our Solution

We patch `Follower.Init()` to validate skeleton data **before** the game tries to apply outfits:

```csharp
public static bool Prefix_Follower_Init(Follower __instance, FollowerBrain brain, FollowerOutfit outfit)
{
    // Use HarmonyLib Traverse to safely access Spine properties
    var spineTraverse = Traverse.Create(__instance).Property("Spine");
    object spine = spineTraverse.GetValue();
    
    if(spine == null || skeleton.Data == null){
        // Reset to safe default outfit
        brain.Info.Outfit = FollowerOutfitType.Follower;
        brain.Info.Clothing = FollowerClothingType.Naked;
    }
    
    return true; // Let original Init continue
}
```

This catches the problem **before** it reaches the game's buggy costume code.

---

## Why This Matters

### Before v1.1.4
- If **any mod** or **any game bug** caused a follower to spawn with custom outfit data before skeleton initialization
- Game would crash with `NullReferenceException` in `Spine.Skin.AddSkin`
- No recovery possible - save file would be stuck in loading screen

### After v1.1.4
- CheatMenu intercepts the initialization
- Detects incomplete skeleton data
- Automatically resets outfit to safe defaults
- Game loads successfully
- Follower appears with default outfit (can be changed later in-game)

---

## What This Fixes

? **v1.1.2 Issue**: "Give All Clothing Items" causing loading screen freeze  
? **v1.1.3 Issue**: Corrupt save files from modified follower outfit data  
? **Future-Proofing**: Protection against similar issues from other mods  
? **Game Bugs**: Protection against potential vanilla game bugs with follower spawning  

---

## Files Changed

- `src/GlobalPatches.cs` - Added `Prefix_Follower_Init` defensive patch
  - Validates skeleton data before outfit application
  - Uses HarmonyLib Traverse to avoid spine-unity assembly reference
  - Comprehensive error logging for debugging
  - Automatic fallback to safe outfit defaults

---

## Compatibility

- ? Fully compatible with v1.1.3 save files
- ? Works alongside other mods
- ? No config changes needed
- ? Drop-in replacement for v1.1.3
- ? Extra layer of protection on top of v1.1.3 fixes

---

## Migration from v1.1.3

### Simple Update
1. Replace `CheatMenu.dll` with v1.1.4
2. That's it! No other changes needed.

### Benefits
- Extra protection if you previously used "Give All Clothing Items"
- Protection against future similar issues
- Better error logging if problems occur
- Peace of mind knowing the mod has multiple layers of protection

---

## Testing

- ? Build successful
- ? Patch applies to Follower.Init successfully
- ? Skeleton validation uses HarmonyLib Traverse (no spine-unity dependency)
- ? Safe fallback to default outfits when skeleton incomplete
- ? Comprehensive error logging
- ? Compatible with all v1.1.x saves

---

## For Developers

If you're experiencing follower loading issues in your own mod:

```csharp
// UNSAFE - What the game does:
FollowerBrain.SetFollowerCostume(skeleton, info, hooded, forceUpdate, setData);

// SAFE - What you should do:
if(follower != null && follower.gameObject != null && follower.gameObject.activeInHierarchy)
{
    // Only set outfit data for fully loaded followers
    follower.Brain.Info.Outfit = desiredOutfit;
    follower.Brain.Info.Clothing = desiredClothing;
    
    // Only call SetOutfit if follower has Spine initialized
    if(follower.Spine != null && follower.Spine.skeleton != null)
    {
        follower.SetOutfit(desiredOutfit, false, Thought.None);
    }
}
```

---

**This release provides belt-and-suspenders protection for follower loading issues!**

*Compatible with Cult of the Lamb v1.5.16.1000+*
