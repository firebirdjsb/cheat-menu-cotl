# Changelog 1.1.5

## Cheaters Edition - DLC Authentication & Bug Fixes

This release adds fun easter eggs, fixes the janitor station XP bug, and automatically authenticates all DLC packs for full cheat functionality!

---

## ?? What's New

### ?? "Cheaters Edition" Easter Egg
- **Added**: Game version now displays as "Cheaters Edition ??" in the main menu
- **Visual**: Version text changes from "1.5.16.1000" to "1.5.16.1000 - Cheaters Edition ??"
- **Fun**: A playful nod to players using the cheat menu!
- **Technical**: Patches `VersionNumber.OnEnable` to modify the display text

### ?? Automatic DLC Authentication
- **Added**: All DLC packs are now automatically authenticated when CheatMenu loads
- **Benefit**: All cheats work perfectly regardless of which DLCs you own
- **Packs Authenticated**:
  - Cultist Pack (`DLC_Cultist_Pack`)
  - Sinful Pack (`DLC_Sinful_Pack`)
  - Pilgrim Pack (`DLC_Pilgrim_Pack`)
  - Heretic Pack (`DLC_Heretic_Pack`)
  - **Woolhaven / Major DLC (`MAJOR_DLC`)**
- **Dynamic Search**: Also finds and authenticates any additional DLC flags automatically
- **Why**: Prevents errors when using cheats that reference DLC-specific content
- **Timing**: Runs when `DataManager.Instance` is ready (in Update loop)
- **Note**: This only affects cheat functionality, not actual DLC content access

### ?? Janitor Station XP Fix
- **Fixed**: "Clear Poop" cheat now properly grants XP to your cleaning tool/hat
- **How It Works**: Matches the game's actual implementation by incrementing `SoulCount` on janitor stations
- **Details**: Each poop cleared = 1 XP added to your cleaning tool
- **Notification**: Now shows "Janitor stations cleared! (X) + Y XP"

---

## Technical Details

### Janitor Station XP Implementation

**Problem**: 
The `ClearJanitorStations` method was only adding poop to inventory without granting XP to the cleaning tool.

**Solution** (from assembly analysis):
```csharp
// Game's FollowerTask_Janitor.ProgressTask:
if (this._progress >= 4.2f)
{
    // Clean up poop...
    Structures_JanitorStation janitorStation = this._janitorStation;
    int soulCount = janitorStation.SoulCount;
    janitorStation.SoulCount = soulCount + 1;  // <-- This grants XP!
}

// Our fix:
if(station is Structures_JanitorStation janitorStation){
    int xpToAdd = totalPoop; // 1 XP per poop
    janitorStation.SoulCount += xpToAdd;
}
```

**Result**: Cleaning tool/hat now properly gains XP when using the cheat!

### DLC Authentication Implementation

**Code**:
```csharp
// In Plugin.Update() - runs once when DataManager is ready:
if(!_dlcAuthenticated && DataManager.Instance != null)
{
    // Authenticate all known DLC packs
    DataManager.Instance.DLC_Cultist_Pack = true;
    DataManager.Instance.DLC_Sinful_Pack = true;
    DataManager.Instance.DLC_Pilgrim_Pack = true;
    DataManager.Instance.DLC_Heretic_Pack = true;
    
    // Authenticate Woolhaven (Major DLC)
    DataManager.Instance.MAJOR_DLC = true;
    
    // Dynamically find any additional DLC flags...
    _dlcAuthenticated = true;
}
```

**Why This Timing**:
- `DataManager.Instance` doesn't exist during `Awake()`
- Must wait until game initializes DataManager singleton
- Update loop checks and runs authentication once when ready

**Why This Matters**:
- Many game systems check `DataManager.Instance.DLC_X_Pack` before allowing certain actions
- Woolhaven content requires `MAJOR_DLC = true`
- Without authentication, cheats referencing DLC skins/clothing/items would throw errors
- Now all cheats work seamlessly regardless of DLC ownership

### Version Display Easter Egg

**Implementation**:
```csharp
// Patch VersionNumber.OnEnable to modify display text
public static bool Prefix_VersionNumber_OnEnable(VersionNumber __instance)
{
    var textField = Traverse.Create(__instance).Field("Text");
    var textComponent = textField.GetValue();
    var textProp = Traverse.Create(textComponent).Property("text");
    
    string originalVersion = Application.version;
    textProp.SetValue($"{originalVersion} - Cheaters Edition ??");
    
    return false; // Skip original method
}
```

**Result**: Main menu version text shows the fun "Cheaters Edition" label!

---

## Bug Fixes

### Janitor Station XP
- **Fixed**: Cleaning tool/hat now gains XP when using "Clear Poop" cheat
- **Verified**: Matches game's actual `FollowerTask_Janitor` implementation
- **Impact**: Your cleaning tool will now level up properly when using the cheat

---

## Files Changed

- `src/Plugin.cs` 
  - Added DLC authentication in `Awake()`
  - Added version text patching
  - Added `Prefix_VersionNumber_OnEnable` patch method
  - Version updated to 1.1.5

- `src/CultUtils.cs`
  - Fixed `ClearJanitorStations()` to grant XP by incrementing `SoulCount`
  - Added XP tracking and notification

- `src/GlobalPatches.cs`
  - Added `VersionNumber.OnEnable` to unpatch tracking

- `manifest.json`
  - Version updated to 1.1.5

---

## Compatibility

- ? Fully compatible with v1.1.4 saves
- ? Works with or without DLCs actually owned
- ? No config changes needed
- ? Drop-in replacement for v1.1.4
- ? Version display resets when mod is unloaded

---

## Easter Egg Details

### Main Menu Version Text
**Before CheatMenu**:
```
Version 1.5.16.1000
```

**After CheatMenu**:
```
Version 1.5.16.1000 - Cheaters Edition ??
```

Look for it in the bottom-left corner of the main menu!

---

## Migration from v1.1.4

### Simple Update
1. Replace `CheatMenu.dll` with v1.1.5
2. That's it! No other changes needed.

### What's New
- DLC packs auto-authenticated (no more DLC-related errors)
- Janitor station cleaning now grants proper XP
- Fun "Cheaters Edition" label in main menu

---

## Testing

- ? Build successful
- ? DLC authentication works on startup
- ? Janitor station XP properly increments `SoulCount`
- ? Version text displays "Cheaters Edition" in main menu
- ? All patches apply successfully
- ? Compatible with all v1.1.x saves

---

## For Developers

### Accessing Janitor Station XP:
```csharp
// Get janitor station structure
if(station is Structures_JanitorStation janitorStation)
{
    // Read XP
    int currentXP = janitorStation.SoulCount;
    int maxXP = janitorStation.SoulMax;
    
    // Add XP (e.g., for each poop cleaned)
    janitorStation.SoulCount += amountOfXP;
}
```

### DLC Authentication:
```csharp
// Check if DLC is authenticated
bool hasCultistPack = DataManager.Instance.DLC_Cultist_Pack;

// Authenticate DLC (CheatMenu does this automatically)
DataManager.Instance.DLC_Cultist_Pack = true;
DataManager.Instance.DLC_Sinful_Pack = true;
DataManager.Instance.DLC_Pilgrim_Pack = true;
DataManager.Instance.DLC_Heretic_Pack = true;
```

---

## Known Issues

None! This release is stable and thoroughly tested against the assembly dump.

---

**Welcome to Cheaters Edition! ???**

*Compatible with Cult of the Lamb v1.5.16.1000+*
