# Changelog 1.1.3

## Critical Save File Fix - Loading Screen Freeze

This emergency patch release fixes a critical bug where using "Give All Clothing Items" would corrupt save file data, causing the game to hang on the loading screen with `NullReferenceException` errors.

---

## Critical Bug Fixes

### Save File Loading Issue
- **Fixed**: Game hanging at loading screen after using "Give All Clothing Items" cheat
- **Fixed**: `FollowerBrainInfo.Protection NullReferenceException` during `LocationManager.SpawnFollowers()`
- **Root Cause**: Clothing data was being set for unloaded followers in save file, causing `Spine.Skin.AddSkin` to fail with null skin data
- **Solution**: `GiveAllClothing` now ONLY modifies followers currently active in the scene

### New Emergency Fix Cheat
- **Added**: "Reset All Follower Outfits" cheat in Follower category
- **Purpose**: Fixes corrupted save files by resetting all follower outfit data to default
- **Usage**: If your game won't load after using clothing cheat, use this to fix your save

---

## Technical Details

### Problem
When `GiveAllClothing` was used in v1.1.2, it modified the `FollowerInfo.Outfit` and `FollowerInfo.Clothing` properties for **all** followers in the save data, including those not currently spawned. When the game later tried to spawn those followers via `LocationManager.SpawnFollowers()`, it attempted to apply the custom outfit/clothing data before the follower's Spine skeleton was fully initialized, resulting in:

```
NullReferenceException: Object reference not set to an instance of an object
Stack trace:
Spine.Skin.AddSkin (Spine.Skin skin)
FollowerBrain.SetFollowerCostume (...)
FollowerOutfit.SetOutfit (...)
Follower.Init (...)
LocationManager.SpawnFollower (...)
LocationManager.SpawnFollowers (...)
```

This caused the game to hang with followers partially spawned and the loading screen stuck.

### Solution
1. **GiveAllClothing Rewrite**: Now only affects followers that are:
   - Currently loaded in the scene (`follower != null`)
   - Active in hierarchy (`follower.gameObject.activeInHierarchy`)
   - Have outfit component initialized (`follower.Outfit != null`)
   - Unloaded followers keep default outfit data

2. **Emergency Fix Cheat**: Resets ALL follower outfit data to defaults:
   - Living followers ? `FollowerOutfitType.Follower`
   - Dead followers ? `FollowerOutfitType.Follower`
   - Elderly followers ? `FollowerOutfitType.Old`
   - All clothing ? `FollowerClothingType.Naked`

---

## How to Fix Your Save File

If you're experiencing the loading screen freeze:

1. **Start the game** - It should still get to the main menu
2. **Load your save** - Even if it hangs, the mod is loading
3. **Wait ~10 seconds** at the loading screen
4. **Press M** (or R3 on controller) to open the cheat menu
5. **Navigate to Followers category**
6. **Click "Reset All Follower Outfits"**
7. **Save and reload**

Your game should now load normally. Follower clothing will be reset to default, but all unlocks are preserved.

---

## Changes Summary

### Modified Functions

#### CultDefinitions.GiveAllClothing()
**Before**: Set clothing data for ALL followers in DataManager, loaded or not  
**After**: Only sets clothing for followers actively loaded in the current scene

**Key Changes**:
- Added strict scene-presence check: `follower.gameObject.activeInHierarchy`
- Added outfit component check: `follower.Outfit != null`
- Removed code that set FollowerInfo clothing for unloaded followers
- Added better error messages for edge cases
- Changed notification to show actual count of dressed followers

#### NEW: FollowerDefinitions.ResetAllFollowerOutfits()
- Iterates ALL follower collections (Followers, Followers_Dead, Followers_Elderly_IDs)
- Resets Outfit and Clothing to safe defaults
- Provides detailed count of fixed followers
- Logs action for debugging

---

## Files Changed
- `src/definitions/CultDefinitions.cs` - GiveAllClothing() rewritten
- `src/definitions/FollowerDefinitions.cs` - Added ResetAllFollowerOutfits()

---

## Testing
- ? Build successful
- ? GiveAllClothing only affects loaded followers
- ? ResetAllFollowerOutfits successfully clears corrupt data
- ? Game loads normally after outfit reset
- ? No more NullReferenceException on follower spawn

---

## Migration from v1.1.2

### If Your Game Still Loads Normally
- Simple drop-in replacement of CheatMenu.dll
- No action needed

### If Your Game Hangs on Loading Screen
1. Replace CheatMenu.dll with v1.1.3
2. Use emergency fix cheat (see "How to Fix Your Save File" above)
3. Consider backing up your save before using any clothing cheats in the future

---

## Recommendations

- **Use "Give All Clothing" only at your base** when followers are loaded
- **Backup your save** before using experimental cheats
- **Report any similar issues** on GitHub Issues tracker

---

**This is a critical patch recommended for all v1.1.2 users, especially those who used the clothing cheat.**
